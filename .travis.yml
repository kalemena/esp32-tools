sudo: required
services:
- docker
env:
  global:
  - REGISTRY_USER=kalemena
  - secure: mhVsoRaptEAtmj8GX2jHZmdwsLwp8xSlWhsmVKJYO81UNFCc4FI1zPF2on1lPSjz8kPaO9vxZF6bg3z26yC8XfGwYOowXGF5a0hg8rM8d7OhlOo/QGH5gJXhlPIbS27+IflBoir/RoHW2mtT0XG6Tyez91RssBQwdFxfxJ7jEAfAbkO+kQOoHchOq9thsCV9dGV7OUsTtTm0we/5FKVcq2hN6/WXbXrBlWWW5owV4bNJFwBI+EnwEim6bsSJ3/E77Qe2LghyFczU7Ik91eSm5sBiVDsYm/tohHpVdtXHxLJs4FMCGZt8SdwmZ6KslCt2+NWmpjS7V1tjF7TyjltKiHJln5Tdf3XrHoL4crpr5QeX2A3wEXZoiHVhI5C/P1KCNtUCoPVVEaQ+kjt/4/7PeGYzDZyqtJs3cV6nzDFWtsSrcjvM14UbiL7nf3jsRR0h3nxeZDEh9lo86s99DWtWdEk9BnMglwz4zopCG7oqbnBNGENWz62Z48Hm/CdTILbR52OCCIKAK84AIkYApvwLxbKsKc1gsWcarTdUzGaab2bT0E52lYPGVwG1G55pROK8D3tJtfW9Jtvd41ROg4s3EvKrD1sYBTaOvYKTWpeS8Fq2EOUeb7IVI5F3N4KVZzvc2w2eFfdOpHYgpjExzupBnFCLWkY2PT0WolHPUOKpbRg=
  matrix:
  - IMAGE="kalemena/esp32tools" VERSION="1.11" REPO="kalemena/esp32tools"
before_script:
- docker pull ubuntu:18.04
- docker pull ${IMAGE}:${VERSION} || true
script:
- |
  docker build --pull --cache-from ${IMAGE}:${VERSION} \
    -t ${IMAGE}:${VERSION} \
    -f Dockerfile \
    --build-arg BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"` \
    --build-arg VCS_REF=`git rev-parse --short HEAD` \
    --build-arg VERSION=${VERSION} .
- docker ps -a
- docker tag ${IMAGE}:${VERSION} ${IMAGE}:latest
- docker images
before_deploy:
- docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
deploy:
  provider: script
  script: docker push ${IMAGE}:${VERSION}; docker push ${IMAGE}:latest
  on:
    branch: master
